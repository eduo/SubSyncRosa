#tag ClassProtected Class CachingCanvasInherits Canvas	#tag Event		Sub Paint(g As Graphics, areas() As REALbasic.Rect)		  evPaint g		End Sub	#tag EndEvent	#tag Method, Flags = &h0		Sub CallRealPaintButEraseFirst(g as graphics)		  #pragma DisableBackgroundTasks		  		  g.ForeColor = window.BackColor		  g.FillRect 0, 0, g.Width, g.Height		  paint g		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub evPaint(g as graphics)		  #pragma DisableBackgroundTasks		  		  if me.LockedPaint = 0 then		    #if TargetWin32 then // maybe its needed on linux too?		      if me.EraseBackground then me.EraseBackground = false		      		      if PicCache = nil or PicCache.Width <> g.width or PicCache.Height <> g.height then		        PicCache = NewPicture( g.Width, g.Height, 32 )		      end if		      if PicCache <> nil then		        CallRealPaintButEraseFirst PicCache.Graphics		        g.drawpicture PicCache, 0, 0		        Return		      end if		    #endif		    		    CallRealPaintButEraseFirst g		  end if		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Lock()		  #pragma DisableBackgroundTasks		  		  me.LockedPaint = me.LockedPaint + 1		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Refresh(eraseBackground as Boolean=true)		  #pragma DisableBackgroundTasks		  		  dim g as Graphics = me.Graphics		  if g <> nil then		    evPaint g		  else		    Super.Refresh false // whatever		  end if		End Sub	#tag EndMethod	#tag Method, Flags = &h0		Sub Unlock()		  #pragma DisableBackgroundTasks		  		  me.LockedPaint = me.LockedPaint - 1		  if me.LockedPaint < 0 then		    Break 		    me.LockedPaint = 0 // :( could this happen?		  end if		  if me.LockedPaint = 0 then		    Refresh		  end if		End Sub	#tag EndMethod	#tag Hook, Flags = &h0		Event Paint(g as graphics)	#tag EndHook	#tag Property, Flags = &h21		Private LockedPaint As Integer	#tag EndProperty	#tag Property, Flags = &h0		PicCache As Picture	#tag EndProperty	#tag ViewBehavior		#tag ViewProperty			Name="AcceptFocus"			Visible=true			Group="Behavior"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="AcceptTabs"			Visible=true			Group="Behavior"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="AutoDeactivate"			Visible=true			Group="Appearance"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Backdrop"			Visible=true			Group="Appearance"			Type="Picture"			EditorType="Picture"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="DoubleBuffer"			Visible=true			Group="Behavior"			InitialValue="False"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Enabled"			Visible=true			Group="Appearance"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="EraseBackground"			Visible=true			Group="Behavior"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Height"			Visible=true			Group="Position"			InitialValue="100"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="HelpTag"			Visible=true			Group="Appearance"			Type="String"			EditorType="MultiLineEditor"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Index"			Visible=true			Group="ID"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="InitialParent"			Type="String"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Left"			Visible=true			Group="Position"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="LockBottom"			Visible=true			Group="Position"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="LockLeft"			Visible=true			Group="Position"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="LockRight"			Visible=true			Group="Position"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="LockTop"			Visible=true			Group="Position"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Name"			Visible=true			Group="ID"			Type="String"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="PicCache"			Group="Behavior"			Type="Picture"		#tag EndViewProperty		#tag ViewProperty			Name="Super"			Visible=true			Group="ID"			Type="String"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="TabIndex"			Visible=true			Group="Position"			InitialValue="0"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="TabPanelIndex"			Group="Position"			InitialValue="0"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="TabStop"			Visible=true			Group="Position"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Top"			Visible=true			Group="Position"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="UseFocusRing"			Visible=true			Group="Appearance"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Visible"			Visible=true			Group="Appearance"			InitialValue="True"			Type="Boolean"			InheritedFrom="Canvas"		#tag EndViewProperty		#tag ViewProperty			Name="Width"			Visible=true			Group="Position"			InitialValue="100"			Type="Integer"			InheritedFrom="Canvas"		#tag EndViewProperty	#tag EndViewBehaviorEnd Class#tag EndClass